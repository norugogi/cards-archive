<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Card ì°¸ì—¬ë³´ë“œ</title>
  <style>
    :root{ --bg:#0b0d10; --card:#14181e; --ink:#e8f0ff; --muted:#96a1b3; --accent:#6aa7ff; --radius:22px; --shadow:0 20px 50px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background: radial-gradient(1200px 700px at 20% -10%, #18202b 0%, transparent 60%), radial-gradient(1200px 700px at 120% 110%, #151c24 0%, transparent 60%), var(--bg); color:var(--ink); display:grid; place-items:center; padding:24px; }
    .wrap{width:min(1180px, 98vw)}
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .title{font-weight:800; letter-spacing:.3px; font-size: clamp(18px, 3vw, 24px)}
    .sub{color:var(--muted); font-size:14px}

    .board{display:grid; grid-template-columns: 1.25fr auto; gap:20px; align-items:start}

    /* Flip Card */
    .scene{width:100%; perspective:1200px}
    .card{position:relative; width:100%; max-width:1028px; height:720px; transform-style:preserve-3d; transition:transform .9s cubic-bezier(.2,.8,.2,1); margin:auto}
    .card.is-flipped{transform: rotateY(180deg)}
    .face{position:absolute; inset:0; backface-visibility:hidden; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);}
    .front{background:#0f1319 url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop') center/cover no-repeat}
    .front::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.5));}
    .frontBadges{position:absolute; inset:auto 18px 18px 18px; display:flex; gap:10px; flex-wrap:wrap}
    .badge{background: rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; font-size:12px; backdrop-filter: blur(6px)}
    .frontTitle{position:absolute; left:20px; bottom:72px; right:20px; font-weight:800; font-size: clamp(28px, 4.5vw, 44px); text-shadow:0 4px 18px rgba(0,0,0,.5)}
    .frontFoot{position:absolute; left:20px; bottom:20px; right:20px; display:flex; justify-content:space-between; align-items:center; color:#cfe1ff; font-size:14px}

    .back{background:linear-gradient(180deg,#0e141d,#0c1118); transform: rotateY(180deg);}
    .backHead{display:flex; justify-content:space-between; align-items:end; padding:18px 18px 0}
    .count{font-weight:800; font-size: clamp(20px, 3.2vw, 26px)}
    .names{position:absolute; inset:56px 0 0; padding: 8px 18px 18px; overflow:auto}
    .pill{display:inline-block; margin:6px; padding:9px 14px; background:#111823; color:#e7efff; border:1px solid #1b2330; border-radius:999px; font-size:14px}

    /* Side panel */
    .panel{min-width:300px; background:linear-gradient(180deg,#10151d,#0f141c); border:1px solid #1a2230; border-radius:16px; box-shadow:var(--shadow); position:relative}
    .panel h3{margin:14px 14px 6px; font-size:14px; color:#c7d6ee}
    .panel .field{display:flex; gap:8px; padding:10px 14px}
    .panel input, .panel textarea{width:100%; background:#0b0f15; border:1px solid #1b2433; color:var(--ink); border-radius:12px; padding:10px 12px; outline:none}
    .panel textarea{min-height:120px; resize:vertical}
    .panel small{display:block; color:#93a0b5; opacity:.9; padding:0 14px 10px}
    .actions{display:flex; gap:8px; padding:12px 14px 14px; flex-wrap:wrap}
    .btn{flex:1; background:#0c121a; border:1px solid #1b2433; color:#cfe1ff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1a68ff,#0f55db); border:none}
    .btn.ghost{background:transparent}

    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .flipBtn{appearance:none; border:none; background:#0c121a; border:1px solid #1b2433; color:#dbe7ff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800}
    .flipBtn:hover{border-color:#2a3952}
    .footer{margin-top:14px; text-align:center; color:#8fa1b8; font-size:12px}

    /* Card-only (viewer) mode */
    body.card-only .board{grid-template-columns: 1fr}
    body.card-only .panel, body.card-only .actions, body.card-only .header .sub{display:none}
    body.card-only .wrap{width:min(1100px, 98vw)}
    body.card-only .scene{display:grid; place-items:center}

    /* Scrollbar aesthetics */
    .names::-webkit-scrollbar{height:12px;width:12px}
    .names::-webkit-scrollbar-thumb{background:#1a2433;border-radius:999px;border:3px solid transparent;background-clip:padding-box}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">Flip Card ì°¸ì—¬ë³´ë“œ</div>
        <div class="sub">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ë’·ë©´ì— ì°¸ì—¬ì ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ Â· GitHub Pages ë°°í¬)</div>
      </div>
      <div class="header-actions">
        <button id="flip" class="flipBtn" title="ì¹´ë“œ ë’¤ì§‘ê¸°">ì¹´ë“œ ë’¤ì§‘ê¸° â†º</button>
      </div>
    </div>

    <div class="board">
      <!-- Card Scene -->
      <div class="scene">
        <div id="card" class="card" role="button" aria-label="ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ë’¤ì§‘ê¸°" tabindex="0">
          <div class="face front" id="front">
            <div class="frontTitle" id="frontTitle">ì´ë²¤íŠ¸ íƒ€ì´í‹€ ì˜ˆì‹œ : ë³´ìŠ¤ í† ë²Œì „</div>
            <div class="frontBadges" id="frontBadges">
              <div class="badge" id="dateBadge">ğŸ“… 2025-08-16</div>
              <div class="badge" id="badgeCount">ğŸ‘¥ ì°¸ì—¬ 0</div>
              <div class="badge">#ì£¼ê°„ì±Œë¦°ì§€</div>
            </div>
            <div class="frontFoot">
              <span>í´ë¦­/í„°ì¹˜í•˜ì—¬ ë’¤ì§‘ê¸°</span>
              <span id="watermark">@YourCommunity</span>
            </div>
          </div>
          <div class="face back">
            <div class="backHead">
              <div class="count">ğŸ‘¥ ì°¸ì—¬ì <span id="count">0</span>ëª…</div>
              <div class="hint">ESC: ì•ë©´ / Enter: ë’·ë©´</div>
            </div>
            <div class="names" id="names"></div>
          </div>
        </div>
      </div>

      <!-- Right Settings Panel -->
      <aside class="panel" aria-label="ì„¤ì • íŒ¨ë„">
        <h3>ì•ë©´ ì„¤ì •</h3>
        <div class="field"><input id="titleInput" placeholder="ì´ë²¤íŠ¸ íƒ€ì´í‹€" /></div>
        <div class="field"><input id="dateInput" placeholder="ì˜ˆ: 2025-08-16" /></div>
        <div class="field"><input id="watermarkInput" placeholder="ì›Œí„°ë§ˆí¬(í•˜ë‹¨ ìš°ì¸¡)" /></div>
        <div class="field"><input id="imageInput" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL (ì„ íƒ)" /></div>
        <small>ì´ë¯¸ì§€ëŠ” ì™¸ë¶€ URL ë˜ëŠ” data URL ì‚¬ìš© ê°€ëŠ¥. ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ê°€ ì ìš©ë©ë‹ˆë‹¤.</small>

        <h3>ì°¸ì—¬ì ì…ë ¥</h3>
        <div class="field"><textarea id="listInput" placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°"></textarea></div>
        <small>ë¶™ì—¬ë„£ì€ ëª…ë‹¨ì€ ìë™ìœ¼ë¡œ ì •ë ¬Â·ì¤‘ë³µ ì œê±°ë©ë‹ˆë‹¤. ì €ì¥ ì‹œ ë¡œì»¬ì— ë³´ê´€ë©ë‹ˆë‹¤.</small>

        <div class="actions">
          <button class="btn" id="loadDemo">ë°ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn ghost" id="clearAll">ì´ˆê¸°í™”</button>
          <button class="btn primary" id="save">ì €ì¥</button>
        </div>

        <h3>ê³µìœ  Â· ë°°í¬</h3>
        <div class="actions">
          <button class="btn" id="exportUrl">ê³µìœ  ë§í¬ ìƒì„±</button>
          <button class="btn" id="exportCardOnlyUrl">ì¹´ë“œ ì „ìš© ë§í¬</button>
          <button class="btn" id="exportHtmlCard">ì¹´ë“œ HTML ì €ì¥</button>
          <button class="btn" id="exportHtmlEditor">ì—ë””í„° HTML ì €ì¥</button>
        </div>

        <h3>GitHub Pages ì„¤ì •</h3>
        <div class="field"><input id="ghOwner" placeholder="Owner (ì˜ˆ: norugogi)" /></div>
        <div class="field"><input id="ghRepo" placeholder="Repo (ì˜ˆ: cards-archive)" /></div>
        <div class="field"><input id="ghBranch" placeholder="Branch (main ë˜ëŠ” gh-pages)" value="main" /></div>
        <div class="field"><input id="ghToken" placeholder="GitHub PAT â€” ë¡œì»¬ì—ë§Œ ì €ì¥" /></div>
        <div class="field"><input id="discordWebhook" placeholder="Discord Webhook URL (ì„ íƒ) â€” ë¡œì»¬ ì €ì¥" /></div>
        <small>í† í°/ì›¹í›… URLì€ ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë˜ë©°, ë‚´ë³´ë‚´ê¸°ëœ ì¹´ë“œ/ë·°ì–´ íŒŒì¼ì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
        <div class="actions">
          <button class="btn primary" id="deployGithub">GitHubì— ë°°í¬ & (ì„ íƒ) ë””ìŠ¤ì½”ë“œ ê³µì§€</button>
          <button class="btn" id="saveGhConfig">ì„¤ì • ì €ì¥</button>
          <button class="btn" id="testWebhook">ì›¹í›… í…ŒìŠ¤íŠ¸</button>
          <button class="btn ghost" id="clearGhConfig">ì„¤ì • ì´ˆê¸°í™”</button>
        </div>
        <small>ë°°í¬ ì‹œ /cards/ìŠ¬ëŸ¬ê·¸.html, history.json, index.html(ì •ì  ëª©ë¡) ê°±ì‹ ë©ë‹ˆë‹¤. PagesëŠ” https://<owner>.github.io/<repo>/ ë¡œ ì„œë¹„ìŠ¤ë©ë‹ˆë‹¤.</small>

        <div class="actions">
          <button class="btn" id="runDiag">ì§„ë‹¨ ì‹¤í–‰</button>
        </div>
      </aside>
    </div>

    <div class="footer">Â© 2025 Flip Card ì°¸ì—¬ë³´ë“œ â€” made for Discord/ì›¹ ê³µìœ . ì˜¤í”„ë¼ì¸/ì •ì  í˜¸ìŠ¤íŒ… ë™ì‘.</div>
  </div>

  <!-- Copy Modal -->
  <div id="copyModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="copyTitle">
    <div class="modal-card">
      <h3 id="copyTitle">ê³µìœ  ë§í¬</h3>
      <input id="copyField" readonly />
      <div class="modal-actions">
        <button class="btn primary" id="tryCopyBtn">í´ë¦½ë³´ë“œ ë³µì‚¬</button>
        <button class="btn" id="selectBtn">ì „ì²´ ì„ íƒ</button>
        <button class="btn" id="shareBtn">ì‹œìŠ¤í…œ ê³µìœ </button>
        <button class="btn ghost" id="closeModal">ë‹«ê¸°</button>
      </div>
      <div id="copyStatus" class="status">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³µì‚¬í•˜ê±°ë‚˜, ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.</div>
    </div>
  </div>

  <script>
  (function(){
    var $ = function(sel){ return document.querySelector(sel); };

    var card = $('#card');
    var namesEl = $('#names');
    var countEl = $('#count');
    var badgeCount = $('#badgeCount');
    var front = $('#front');

    var titleInput = $('#titleInput');
    var dateInput = $('#dateInput');
    var wmInput = $('#watermarkInput');
    var imgInput = $('#imageInput');
    var listInput = $('#listInput');

    var frontTitle = $('#frontTitle');
    var watermark = $('#watermark');
    var dateBadge = $('#dateBadge');

    var ghOwner = $('#ghOwner');
    var ghRepo = $('#ghRepo');
    var ghBranch = $('#ghBranch');
    var ghToken = $('#ghToken');
    var discordWebhook = $('#discordWebhook');

    var storeKey = 'flip-card-participation-v2';
    var storeGhKey = 'flip-card-gh-config-v2';
    var viewMode = 'edit';

    function storageAvailable(){
      try{ var k='__ls_test__'+Math.random(); localStorage.setItem(k,'1'); localStorage.removeItem(k); return true; }catch(e){ return false; }
    }

    function sanitize(list){
      var arr = [];
      for(var i=0;i<list.length;i++){ var x = (list[i]||'').trim(); if(x){ arr.push(x); } }
      // de-dup
      var map={}, out=[]; for(i=0;i<arr.length;i++){ var v=arr[i]; if(!map[v]){ map[v]=1; out.push(v);} }
      // sort ko
      out.sort(function(a,b){ return a.localeCompare(b,'ko'); });
      return out;
    }

    function render(list){
      namesEl.innerHTML = '';
      for(var i=0;i<list.length;i++){
        var pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = list[i];
        namesEl.appendChild(pill);
      }
      countEl.textContent = String(list.length);
      badgeCount.textContent = 'ğŸ‘¥ ì°¸ì—¬ ' + list.length;
    }

    function apply(data){
      frontTitle.textContent = data.title || '';
      watermark.textContent = data.water || '';
      if(data.date){ dateBadge.textContent = 'ğŸ“… ' + data.date; }
      if(data.img){ front.style.backgroundImage = "url('" + data.img.replace(/'/g,"\\'") + "')"; }
      else { front.style.backgroundImage = "url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop')"; }
      render(data.list||[]);
    }

    function fillInputs(data){
      titleInput.value = data.title || '';
      dateInput.value = data.date || '';
      wmInput.value = data.water || '';
      imgInput.value = data.img || '';
      listInput.value = (data.list||[]).join('\n');
    }

    function save(){
      if(viewMode==='card') return;
      var data = {
        title: (titleInput.value||'').trim() || 'ì´ë²¤íŠ¸ íƒ€ì´í‹€ ì˜ˆì‹œ : ë³´ìŠ¤ í† ë²Œì „',
        date: (dateInput.value||'').trim() || new Date().toISOString().slice(0,10),
        water: (wmInput.value||'').trim() || '@YourCommunity',
        img: (imgInput.value||'').trim(),
        list: sanitize((listInput.value||'').split(/\n|,|;/))
      };
      if(storageAvailable()){
        try{ localStorage.setItem(storeKey, JSON.stringify(data)); }catch(e){}
      }
      apply(data);
    }

    function buildPayload(){
      return {
        t: (titleInput.value||'').trim(),
        d: (dateInput.value||'').trim(),
        w: (wmInput.value||'').trim(),
        i: (imgInput.value||'').trim(),
        l: sanitize((listInput.value||'').split(/\n|,|;/))
      };
    }

    function encodeToUrl(opts){
      if(!opts) opts={};
      var payload = buildPayload();
      var q = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(payload)))));
      var u = new URL(location.href);
      u.searchParams.set('q', q);
      if(opts.view==='card') u.searchParams.set('view','card'); else u.searchParams.delete('view');
      u.hash = '';
      return u.origin + u.pathname + '?' + u.searchParams.toString();
    }

    function decodeFromUrl(){
      var u = new URL(location.href);
      var q = u.searchParams.get('q');
      viewMode = (u.searchParams.get('view')==='card') ? 'card' : 'edit';
      if(viewMode==='card') setCardOnlyMode(true);
      if(!q){
        var emb = loadEmbedded();
        if(emb){ if(emb.view==='card') setCardOnlyMode(true); fillInputs(emb.data); apply(emb.data); return emb.data; }
        if(storageAvailable()){
          var raw = localStorage.getItem(storeKey);
          if(raw){ try{ var dat = JSON.parse(raw); fillInputs(dat); apply(dat); return dat; }catch(e){} }
        }
        return null;
      }
      try{
        var obj = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(q)))));
        var data = { title: obj.t||'', date: obj.d||'', water: obj.w||'', img: obj.i||'', list: obj.l||[] };
        fillInputs(data); apply(data); if(viewMode!=='card' && storageAvailable()) localStorage.setItem(storeKey, JSON.stringify(data));
        return data;
      }catch(e){ return null; }
    }

    function loadEmbedded(){
      try{
        var s = document.getElementById('__EMBEDDED_DATA__');
        if(!s) return null;
        var obj = JSON.parse(s.textContent||'{}');
        return { view: obj.view||'card', data: { title: obj.t||'', date: obj.d||'', water: obj.w||'', img: obj.i||'', list: obj.l||[] } };
      }catch(e){ return null; }
    }

    function setCardOnlyMode(on){
      if(on){ document.body.classList.add('card-only'); }
      else { document.body.classList.remove('card-only'); }
      var inputs = document.querySelectorAll('.panel input, .panel textarea, .panel button');
      for(var i=0;i<inputs.length;i++){ inputs[i].disabled = !!on; }
    }

    function openCopyModal(text){
      var modal = $('#copyModal'); var field = $('#copyField'); var status = $('#copyStatus');
      field.value = text; modal.classList.remove('hidden'); field.focus(); field.select();
      safeCopy(text).then(function(ok){ status.textContent = ok ? 'ë³µì‚¬ ì™„ë£Œ! ë‹¤ë¥¸ ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.' : 'í´ë¦½ë³´ë“œ ê¶Œí•œ ì œí•œìœ¼ë¡œ ìë™ ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”.'; }).catch(function(){ status.textContent = 'ìë™ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì „ì²´ ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.'; });
    }

    function safeCopy(text){
      return new Promise(function(resolve){
        try{
          if(navigator.clipboard && window.isSecureContext){
            navigator.clipboard.writeText(text).then(function(){ resolve(true); }).catch(function(){ resolve(false); });
            return;
          }
        }catch(e){}
        try{
          var ta = document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.focus(); ta.select(); var ok=document.execCommand('copy'); document.body.removeChild(ta); resolve(ok);
        }catch(e){ resolve(false); }
      });
    }

    function b64(text){ return btoa(unescape(encodeURIComponent(text))); }
    function slugify(str){ var s=(str||'card').toLowerCase(); s=s.replace(/[^\wê°€-í£\- ]+/g,''); s=s.trim().replace(/\s+/g,'-'); if(!s) s='card'; return s.slice(0,80); }

    function computeBaseUrl(){ return 'https://' + ghOwner.value + '.github.io/' + ghRepo.value; }

    function buildStaticIndexHtml(hist){
      var html='';
      html += '<!DOCTYPE html>\n<html lang="ko">\n<head>\n<meta charset="utf-8"/>\n<meta name="viewport" content="width=device-width, initial-scale=1"/>';
      html += '<title>ì¹´ë“œ íˆìŠ¤í† ë¦¬</title>\n<style>body{margin:0;background:#0b0d10;color:#e8f0ff;font-family:ui-sans-serif,system-ui} .layout{display:grid;grid-template-columns:320px 1fr;min-height:100vh} aside{background:#0f141c;border-right:1px solid #1a2230;padding:16px} main{display:grid;place-items:center;padding:24px} h1{font-size:18px;margin:0 0 12px;color:#cfe1ff} ul{list-style:none;padding:0;margin:0} li{margin:6px 0} a{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid #1a2230;border-radius:10px;background:#0b0f15;color:#e8f0ff;text-decoration:none} a:hover{border-color:#2a3952} .meta{display:flex;flex-direction:column;font-size:12px} .meta .t{font-weight:700} iframe{width:1028px;max-width:95vw;height:720px;border:0;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.35);background:#111}</style>\n';
      html += '</head>\n<body>\n<div class="layout">\n<aside>\n<h1>ì¹´ë“œ íˆìŠ¤í† ë¦¬</h1>\n<ul>';
      for(var i=0;i<hist.length;i++){
        var it = hist[i];
        var t = (it.title||''); var d=(it.date||''); var c=(it.count||0); var url=(it.url||'#');
        html += '<li><a href="' + url.replace(/"/g,'&quot;') + '" target="viewer">';
        html += '<div class="meta"><div class="t">' + t.replace(/&/g,'&amp;').replace(/</g,'&lt;') + '</div><div>' + d + ' Â· ì°¸ì—¬ ' + c + 'ëª…</div></div>';
        html += '</a></li>';
      }
      html += '</ul>\n</aside>\n<main>\n<iframe name="viewer" title="ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°"></iframe>\n</main>\n</div>\n</body>\n</html>';
      return html;
    }

    function buildCardHtmlString(options){
      var opt = options||{}; var view = opt.view==='card' ? 'card' : 'edit';
      // clone current document and embed payload for self-bootstrapping
      var payload = buildPayload();
      var docEl = document.documentElement.cloneNode(true);
      if(view==='card'){ docEl.querySelector('body').classList.add('card-only'); }
      var s = document.createElement('script'); s.type='application/json'; s.id='__EMBEDDED_DATA__'; s.textContent = JSON.stringify({ view:view, t:payload.t, d:payload.d, w:payload.w, i:payload.i, l:payload.l });
      docEl.querySelector('body').appendChild(s);
      return '<!DOCTYPE html>\n' + docEl.outerHTML;
    }

    function ghHeaders(){ return { 'Authorization': 'token ' + ghToken.value, 'Accept': 'application/vnd.github+json' }; }
    function ghGet(path){
      var url = 'https://api.github.com/repos/' + ghOwner.value + '/' + ghRepo.value + '/contents/' + path + '?ref=' + ghBranch.value;
      return fetch(url, { headers: ghHeaders() }).then(function(res){ if(res.status===404) return null; if(!res.ok) throw new Error('GET '+path+' '+res.status); return res.json(); });
    }
    function ghPut(path, content, message){
      return ghGet(path).then(function(get){ var sha = get && get.sha; var url = 'https://api.github.com/repos/' + ghOwner.value + '/' + ghRepo.value + '/contents/' + path; var body = { message: message, content: b64(content), branch: ghBranch.value }; if(sha) body.sha = sha; return fetch(url, { method:'PUT', headers: ghHeaders(), body: JSON.stringify(body) }); }).then(function(res){ if(!res.ok) throw new Error('PUT '+path+' '+res.status); return res.json(); });
    }

    function deployToGithub(){
      if(!ghOwner.value || !ghRepo.value || !ghBranch.value || !ghToken.value){ alert('GitHub ì„¤ì •ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      var payload = buildPayload();
      var date = payload.d || new Date().toISOString().slice(0,10);
      var slug = date + '-' + slugify(payload.t||'card');
      var cardHtml = buildCardHtmlString({view:'card'});

      var cardPath = 'cards/' + slug + '.html';
      ghPut(cardPath, cardHtml, 'feat(card): ' + slug)
      .then(function(){
        var baseUrl = computeBaseUrl();
        var cardUrl = baseUrl + '/' + cardPath;
        return ghGet('history.json').then(function(existed){
          var hist=[]; if(existed && existed.content){ try{ hist = JSON.parse(decodeURIComponent(escape(atob(existed.content)))); }catch(e){ hist=[]; }
          }
          var entry = { id: slug, title: payload.t||'ë¬´ì œ', date: date, image: payload.i||'', count: payload.l.length, url: cardUrl, createdAt: new Date().toISOString() };
          // de-dup by id
          var newHist=[entry]; for(var i=0;i<hist.length;i++){ if(hist[i].id!==entry.id) newHist.push(hist[i]); }
          return ghPut('history.json', JSON.stringify(newHist, null, 2), 'chore(history): add ' + slug).then(function(){ return newHist; });
        }).then(function(newHist){
          // static index.html
          var indexHtml = buildStaticIndexHtml(newHist);
          return ghPut('index.html', indexHtml, 'chore(viewer): update index');
        }).then(function(){
          // webhook (optional)
          var urlRaw = (discordWebhook.value||'').trim();
          if(!urlRaw){ return null; }
          var okFormat = /^(https?:\/\/(discord\.com|discordapp\.com)\/api\/(v\d+\/)?webhooks\/\d+\/[A-Za-z0-9_\-]+)$/.test(urlRaw);
          if(!okFormat){ alert('ì›¹í›… URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.'); return null; }
          var baseUrl = computeBaseUrl();
          var cardUrl = baseUrl + '/' + cardPath;
          return fetch(urlRaw, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: 'ìƒˆ ì¹´ë“œ ë“±ë¡: ' + (payload.t||'ë¬´ì œ') + '\në³´ê¸°: ' + cardUrl + '\nì „ì²´ íˆìŠ¤í† ë¦¬: ' + baseUrl + '/' }) });
        }).then(function(){
          var baseUrl = computeBaseUrl();
          alert('ë°°í¬ ì™„ë£Œ!\nì¹´ë“œ: ' + baseUrl + '/' + cardPath + '\níˆìŠ¤í† ë¦¬: ' + baseUrl + '/');
        });
      }).catch(function(err){ alert('ë°°í¬ ì¤‘ ì˜¤ë¥˜: ' + err); });
    }

    // Events
    $('#flip').addEventListener('click', function(){ card.classList.toggle('is-flipped'); });
    card.addEventListener('click', function(){ card.classList.toggle('is-flipped'); });
    card.addEventListener('keydown', function(e){ if(e.key==='Enter') card.classList.add('is-flipped'); if(e.key==='Escape') card.classList.remove('is-flipped'); });

    $('#save').addEventListener('click', save);
    $('#clearAll').addEventListener('click', function(){ if(viewMode==='card') return; if(storageAvailable()) localStorage.removeItem(storeKey); location.reload(); });
    $('#loadDemo').addEventListener('click', function(){ if(viewMode==='card') return; var demo={ title:'ê²°ì‚¬ ì£¼ê°„ ë ˆì´ë“œ : ì ˆëŒ€ì ê³µëµ', date:new Date().toISOString().slice(0,10), water:'@TheWind Guild', img:'', list:['ë…¸ë£¨','ì†Œì•ˆ','ìœˆë‘¥ì´','ì•„í†°','ì•„ì˜¤í‚¤ì§€','ë¬´ì¸ ','ë£¨ë¯¸','ë¼í‹°','ì¹¸ë‚˜','ì‹œì˜¨','ì—ë¦¬ì¹´','ì§„','ë¼ê·¸','ì¹´ì¼','ë©”ì´','í•€','ë¡œì›°','ì„¸ë¼','í•˜ì¹´','ë„ìœ¤'] }; fillInputs(demo); apply(demo); if(storageAvailable()) localStorage.setItem(storeKey, JSON.stringify(demo)); });

    // live preview
    var liveInputs=[titleInput,dateInput,wmInput,imgInput,listInput];
    for(var li=0; li<liveInputs.length; li++){
      (function(el){ el.addEventListener('input', function(){ if(viewMode==='card') return; var d={ title:titleInput.value, date:dateInput.value, water:wmInput.value, img:imgInput.value, list:sanitize((listInput.value||'').split(/\n|,|;/)) }; apply(d); }); })(liveInputs[li]);
    }

    // Sharing
    $('#exportUrl').addEventListener('click', function(){ var url = encodeToUrl({view:'edit'}); openCopyModal(url); });
    $('#exportCardOnlyUrl').addEventListener('click', function(){ var url = encodeToUrl({view:'card'}); openCopyModal(url); });
    $('#exportHtmlCard').addEventListener('click', function(){ var html = buildCardHtmlString({view:'card'}); var blob=new Blob([html],{type:'text/html;charset=utf-8'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); var base=(titleInput.value||'flip-card').replace(/[^\wê°€-í£\-_. ]+/g,'').slice(0,60).trim()||'flip-card'; a.download=base+'-card.html'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(a.href);},1000); });
    $('#exportHtmlEditor').addEventListener('click', function(){ var html = buildCardHtmlString({view:'edit'}); var blob=new Blob([html],{type:'text/html;charset=utf-8'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); var base=(titleInput.value||'flip-card').replace(/[^\wê°€-í£\-_. ]+/g,'').slice(0,60).trim()||'flip-card'; a.download=base+'-editor.html'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(function(){URL.revokeObjectURL(a.href);},1000); });

    // GitHub config + actions
    $('#saveGhConfig').addEventListener('click', function(){ var cfg={ owner:ghOwner.value.trim(), repo:ghRepo.value.trim(), branch:(ghBranch.value.trim()||'main'), token:ghToken.value.trim(), webhook: (discordWebhook.value||'').trim() }; if(storageAvailable()){ try{ localStorage.setItem(storeGhKey, JSON.stringify(cfg)); }catch(e){ alert('ë¸Œë¼ìš°ì € ì €ì¥ì†Œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì–´ ì„¤ì •ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; } } alert('GitHub/ì›¹í›… ì„¤ì • ì €ì¥ë¨(ë¡œì»¬)'); });
    $('#clearGhConfig').addEventListener('click', function(){ if(storageAvailable()) localStorage.removeItem(storeGhKey); ghOwner.value=''; ghRepo.value=''; ghBranch.value='main'; ghToken.value=''; discordWebhook.value=''; alert('ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); });
    $('#testWebhook').addEventListener('click', function(){ var url=(discordWebhook.value||'').trim(); if(!url){ alert('Webhook URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; } var ok=/^(https?:\/\/(discord\.com|discordapp\.com)\/api\/(v\d+\/)?webhooks\/\d+\/[A-Za-z0-9_\-]+)$/.test(url); if(!ok){ alert('ì›¹í›… URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šì•„ìš”.'); return; } fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:'âœ… ì›¹í›… í…ŒìŠ¤íŠ¸: Flip Card ì°¸ì—¬ë³´ë“œ'})}).then(function(res){ if(res.ok) alert('ì›¹í›… í…ŒìŠ¤íŠ¸: ì„±ê³µ! ì±„ë„ì„ í™•ì¸í•˜ì„¸ìš”.'); else res.text().then(function(t){ alert('ì›¹í›… í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ('+res.status+') '+t.slice(0,160)); }); }).catch(function(e){ alert('ì›¹í›… ìš”ì²­ ì—ëŸ¬: '+e); }); });
    $('#deployGithub').addEventListener('click', deployToGithub);

    // Copy modal events
    $('#tryCopyBtn').addEventListener('click', function(){ var url=$('#copyField').value; safeCopy(url).then(function(ok){ $('#copyStatus').textContent = ok ? 'ë³µì‚¬ ì™„ë£Œ! ë‹¤ë¥¸ ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.' : 'ë³µì‚¬ ì‹¤íŒ¨. ì „ì²´ ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.'; }); });
    $('#selectBtn').addEventListener('click', function(){ var f=$('#copyField'); f.focus(); f.select(); });
    $('#closeModal').addEventListener('click', function(){ $('#copyModal').classList.add('hidden'); });
    $('#shareBtn').addEventListener('click', function(){ var url=$('#copyField').value; if(navigator.share){ navigator.share({title:'Flip Card ì°¸ì—¬ë³´ë“œ', text:'ê³µìœ  ë§í¬', url:url}).catch(function(){}); } else { $('#copyStatus').textContent='ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œìŠ¤í…œ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³µì‚¬ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì„¸ìš”.'; } });

    function runDiagnostics(){
      var ok1=false; try{ var payload=buildPayload(); var url=encodeToUrl({view:'edit'}); var q=new URL(url).searchParams.get('q'); var obj=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(q))))); ok1 = JSON.stringify({t:payload.t,d:payload.d,w:payload.w,i:payload.i,l:payload.l})===JSON.stringify(obj); }catch(e){}
      var ok2=false; try{ var k='__test_'+Math.random(); localStorage.setItem(k,'1'); ok2 = (localStorage.getItem(k)==='1'); localStorage.removeItem(k);}catch(e){}
      var ok3=false; try{ var html=buildCardHtmlString({view:'card'}); ok3 = html.indexOf('__EMBEDDED_DATA__')>-1; }catch(e){}
      var ok4 = !!(ghOwner.value && ghRepo.value && ghBranch.value && ghToken.value);
      alert('ì§„ë‹¨ ê²°ê³¼:\n1) ë§í¬ ì¸ì½”ë”©/ë””ì½”ë”©: '+(ok1?'OK':'FAIL')+'\n2) ë¡œì»¬ ì €ì¥ì†Œ: '+(ok2?'OK':'FAIL')+'\n3) ë‚´ë³´ë‚´ê¸°(ì„ë² ë“œ) ìƒì„±: '+(ok3?'OK':'FAIL')+'\n4) GitHub ì„¤ì • ì…ë ¥ë¨: '+(ok4?'OK':'ë¯¸ì…ë ¥')); }
    $('#runDiag').addEventListener('click', runDiagnostics);

    // Initial load
    if(!decodeFromUrl()){
      if(storageAvailable()){
        var rawGh = localStorage.getItem(storeGhKey); if(rawGh){ try{ var c=JSON.parse(rawGh); ghOwner.value=c.owner||''; ghRepo.value=c.repo||''; ghBranch.value=c.branch||'main'; ghToken.value=c.token||''; discordWebhook.value=c.webhook||''; }catch(e){} }
      }
    }
  })();
  </script>
</body>
</html>
