<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flip Card ì°¸ì—¬ë³´ë“œ</title>
  <style>
    :root{ --bg:#0b0d10; --card:#14181e; --ink:#e8f0ff; --muted:#96a1b3; --accent:#6aa7ff; --radius:22px; --shadow:0 20px 50px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background: radial-gradient(1200px 700px at 20% -10%, #18202b 0%, transparent 60%), radial-gradient(1200px 700px at 120% 110%, #151c24 0%, transparent 60%), var(--bg); color:var(--ink); display:grid; place-items:center; padding:24px; }
    .wrap{width:min(1180px, 98vw)}
    .header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px}
    .title{font-weight:800; letter-spacing:.3px; font-size: clamp(18px, 3vw, 24px)}
    .sub{color:var(--muted); font-size:14px}

    .board{display:grid; grid-template-columns: 1.25fr auto; gap:20px; align-items:start}

    /* Flip Card */
    .scene{width:100%; perspective:1200px}
    .card{position:relative; width:100%; max-width:1028px; height:720px; transform-style:preserve-3d; transition:transform .9s cubic-bezier(.2,.8,.2,1); margin:auto}
    .card.is-flipped{transform: rotateY(180deg)}
    .face{position:absolute; inset:0; backface-visibility:hidden; border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);}
    .front{background:#0f1319 url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop') center/cover no-repeat}
    .front::after{content:""; position:absolute; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.5));}
    .frontBadges{position:absolute; inset:auto 18px 18px 18px; display:flex; gap:10px; flex-wrap:wrap}
    .badge{background: rgba(255,255,255,.1); color:#fff; border:1px solid rgba(255,255,255,.18); padding:6px 10px; border-radius:999px; font-size:12px; backdrop-filter: blur(6px)}
    .frontTitle{position:absolute; left:20px; bottom:72px; right:20px; font-weight:800; font-size: clamp(28px, 4.5vw, 44px); text-shadow:0 4px 18px rgba(0,0,0,.5)}
    .frontFoot{position:absolute; left:20px; bottom:20px; right:20px; display:flex; justify-content:space-between; align-items:center; color:#cfe1ff; font-size:14px}

    .back{background:linear-gradient(180deg,#0e141d,#0c1118); transform: rotateY(180deg);}
    .backHead{display:flex; justify-content:space-between; align-items:end; padding:18px 18px 0}
    .count{font-weight:800; font-size: clamp(20px, 3.2vw, 26px)}
    .names{position:absolute; inset:56px 0 0; padding: 8px 18px 18px; overflow:auto}
    .pill{display:inline-block; margin:6px; padding:9px 14px; background:#111823; color:#e7efff; border:1px solid #1b2330; border-radius:999px; font-size:14px}

    /* Side panel */
    .panel{min-width:300px; background:linear-gradient(180deg,#10151d,#0f141c); border:1px solid #1a2230; border-radius:16px; box-shadow:var(--shadow); position:relative}
    .panel h3{margin:14px 14px 6px; font-size:14px; color:#c7d6ee}
    .panel .field{display:flex; gap:8px; padding:10px 14px}
    .panel input, .panel textarea{width:100%; background:#0b0f15; border:1px solid #1b2433; color:var(--ink); border-radius:12px; padding:10px 12px; outline:none}
    .panel textarea{min-height:120px; resize:vertical}
    .panel small{display:block; color:#93a0b5; opacity:.9; padding:0 14px 10px}
    .actions{display:flex; gap:8px; padding:12px 14px 14px; flex-wrap:wrap}
    .btn{flex:1; background:#0c121a; border:1px solid #1b2433; color:#cfe1ff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:700}
    .btn.primary{background:linear-gradient(180deg,#1a68ff,#0f55db); border:none}
    .btn.ghost{background:transparent}

    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .flipBtn{appearance:none; border:none; background:#0c121a; border:1px solid #1b2433; color:#dbe7ff; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:800}
    .flipBtn:hover{border-color:#2a3952}
    .footer{margin-top:14px; text-align:center; color:#8fa1b8; font-size:12px}

    /* Modal */
    .modal{position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.45); z-index:50}
    .hidden{display:none}
    .modal-card{width:min(560px, 92vw); background:linear-gradient(180deg,#10151d,#0f141c); border:1px solid #1a2230; border-radius:16px; box-shadow:var(--shadow); padding:16px}
    .modal-card h3{margin:0 0 10px; font-size:16px; color:#cfe1ff}
    .modal-card input{width:100%; background:#0b0f15; border:1px solid #1b2433; color:#e8f0ff; border-radius:10px; padding:10px 12px}
    .modal-actions{display:flex; gap:8px; margin-top:12px}
    .modal-actions .btn{flex:unset}
    .status{margin-top:8px; color:#9fb3cc; font-size:12px}

    /* Card-only (viewer) mode */
    body.card-only .board{grid-template-columns: 1fr}
    body.card-only .panel, body.card-only .actions, body.card-only .header .sub{display:none}
    body.card-only .wrap{width:min(1100px, 98vw)}
    body.card-only .scene{display:grid; place-items:center}

    /* Scrollbar aesthetics */
    .names::-webkit-scrollbar{height:12px;width:12px}
    .names::-webkit-scrollbar-thumb{background:#1a2433;border-radius:999px;border:3px solid transparent;background-clip:padding-box}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <div class="title">Flip Card ì°¸ì—¬ë³´ë“œ</div>
        <div class="sub">ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ë’·ë©´ì— ì°¸ì—¬ì ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. (ë¡œì»¬ ì €ì¥ ì§€ì› Â· GitHub Pages ë°°í¬ ì§€ì›)</div>
      </div>
      <div class="header-actions">
        <button id="flip" class="flipBtn" title="ì¹´ë“œ ë’¤ì§‘ê¸°">ì¹´ë“œ ë’¤ì§‘ê¸° â†º</button>
      </div>
    </div>

    <div class="board">
      <!-- Card Scene -->
      <div class="scene">
        <div id="card" class="card" role="button" aria-label="ì¹´ë“œë¥¼ í´ë¦­í•˜ì—¬ ë’¤ì§‘ê¸°" tabindex="0">
          <div class="face front" id="front">
            <div class="frontTitle" id="frontTitle">ì´ë²¤íŠ¸ íƒ€ì´í‹€ ì˜ˆì‹œ : ë³´ìŠ¤ í† ë²Œì „</div>
            <div class="frontBadges" id="frontBadges">
              <div class="badge">ğŸ“… 2025-08-16</div>
              <div class="badge" id="badgeCount">ğŸ‘¥ ì°¸ì—¬ 0</div>
              <div class="badge">#ì£¼ê°„ì±Œë¦°ì§€</div>
            </div>
            <div class="frontFoot">
              <span>í´ë¦­/í„°ì¹˜í•˜ì—¬ ë’¤ì§‘ê¸°</span>
              <span id="watermark">@YourCommunity</span>
            </div>
          </div>
          <div class="face back">
            <div class="backHead">
              <div class="count">ğŸ‘¥ ì°¸ì—¬ì <span id="count">0</span>ëª…</div>
              <div class="hint">ESC: ì•ë©´ / Enter: ë’·ë©´</div>
            </div>
            <div class="names" id="names"></div>
          </div>
        </div>
      </div>

      <!-- Right Settings Panel -->
      <aside class="panel" aria-label="ì„¤ì • íŒ¨ë„">
        <h3>ì•ë©´ ì„¤ì •</h3>
        <div class="field"><input id="titleInput" placeholder="ì´ë²¤íŠ¸ íƒ€ì´í‹€" /></div>
        <div class="field"><input id="dateInput" placeholder="ì˜ˆ: 2025-08-16" /></div>
        <div class="field"><input id="watermarkInput" placeholder="ì›Œí„°ë§ˆí¬(í•˜ë‹¨ ìš°ì¸¡)" /></div>
        <div class="field"><input id="imageInput" placeholder="ë°°ê²½ ì´ë¯¸ì§€ URL (ì„ íƒ)" /></div>
        <small>ì´ë¯¸ì§€ëŠ” ì™¸ë¶€ URL ë˜ëŠ” data URL ì‚¬ìš© ê°€ëŠ¥. ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ì´ë¯¸ì§€ê°€ ì ìš©ë©ë‹ˆë‹¤.</small>

        <h3>ì°¸ì—¬ì ì…ë ¥</h3>
        <div class="field"><textarea id="listInput" placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ê±°ë‚˜ ë¶™ì—¬ë„£ê¸°"></textarea></div>
        <small>ë¶™ì—¬ë„£ì€ ëª…ë‹¨ì€ ìë™ìœ¼ë¡œ ì •ë ¬Â·ì¤‘ë³µ ì œê±°ë©ë‹ˆë‹¤. ì €ì¥ ì‹œ ë¡œì»¬ì— ë³´ê´€ë©ë‹ˆë‹¤.</small>

        <div class="actions">
          <button class="btn" id="loadDemo">ë°ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="btn ghost" id="clearAll">ì´ˆê¸°í™”</button>
          <button class="btn primary" id="save">ì €ì¥</button>
        </div>

        <h3>ê³µìœ  Â· ë°°í¬</h3>
        <div class="actions">
          <button class="btn" id="exportUrl">ê³µìœ  ë§í¬ ìƒì„±</button>
          <button class="btn" id="exportCardOnlyUrl">ì¹´ë“œ ì „ìš© ë§í¬</button>
          <button class="btn" id="exportHtmlCard">ì¹´ë“œ HTML ì €ì¥</button>
          <button class="btn" id="exportHtmlEditor">ì—ë””í„° HTML ì €ì¥</button>
        </div>

        <h3>GitHub Pages ì„¤ì •</h3>
        <div class="field"><input id="ghOwner" placeholder="Owner (ì˜ˆ: yourname)" /></div>
        <div class="field"><input id="ghRepo" placeholder="Repo (ì˜ˆ: cards-archive)" /></div>
        <div class="field"><input id="ghBranch" placeholder="Branch (ê¸°ë³¸ gh-pages)" value="gh-pages" /></div>
        <div class="field"><input id="ghToken" placeholder="GitHub Personal Access Token (repo:contents ê¶Œí•œ) â€” ë¡œì»¬ì—ë§Œ ì €ì¥" /></div>
        <div class="field"><input id="discordWebhook" placeholder="Discord Webhook URL (ì„ íƒ) â€” ë¡œì»¬ì—ë§Œ ì €ì¥" /></div>
        <small>í† í°/ì›¹í›… URLì€ ë¸Œë¼ìš°ì € ë¡œì»¬ì—ë§Œ ì €ì¥ë˜ë©°, ë‚´ë³´ë‚´ê¸°ëœ ì¹´ë“œ/ë·°ì–´ íŒŒì¼ì—ëŠ” í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
        <div class="actions">
          <button class="btn primary" id="deployGithub">GitHubì— ë°°í¬ & (ì„ íƒ) ë””ìŠ¤ì½”ë“œ ê³µì§€</button>
          <button class="btn" id="saveGhConfig">ì„¤ì • ì €ì¥</button>
          <button class="btn ghost" id="clearGhConfig">ì„¤ì • ì´ˆê¸°í™”</button>
        </div>
        <small>ë°°í¬ ì‹œ /cards/ìŠ¬ëŸ¬ê·¸.html, history.json, index.html(ì—†ìœ¼ë©´ ìƒì„±)ì´ ê°±ì‹ ë©ë‹ˆë‹¤. PagesëŠ” https://<owner>.github.io/<repo>/ ë¡œ ì„œë¹„ìŠ¤ë©ë‹ˆë‹¤.</small>

        <div class="actions">
          <button class="btn" id="runDiag">ì§„ë‹¨ ì‹¤í–‰</button>
        </div>
      </aside>
    </div>

    <div class="footer">Â© 2025 Flip Card ì°¸ì—¬ë³´ë“œ â€” made for Discord/ì›¹ ê³µìœ . ì˜¤í”„ë¼ì¸/ì •ì  í˜¸ìŠ¤íŒ… ë™ì‘.</div>
  </div>

  <!-- Copy Modal -->  <div id="copyModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="copyTitle">
    <div class="modal-card">
      <h3 id="copyTitle">ê³µìœ  ë§í¬</h3>
      <input id="copyField" readonly />
      <div class="modal-actions">
        <button class="btn primary" id="tryCopyBtn">í´ë¦½ë³´ë“œ ë³µì‚¬</button>
        <button class="btn" id="selectBtn">ì „ì²´ ì„ íƒ</button>
        <button class="btn" id="shareBtn">ì‹œìŠ¤í…œ ê³µìœ </button>
        <button class="btn ghost" id="closeModal">ë‹«ê¸°</button>
      </div>
      <div id="copyStatus" class="status">ë²„íŠ¼ì„ ëˆŒëŸ¬ ë³µì‚¬í•˜ê±°ë‚˜, ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.</div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const card = $('#card');
    const namesEl = $('#names');
    const countEl = $('#count');
    const badgeCount = $('#badgeCount');
    const front = $('#front');

    const titleInput = $('#titleInput');
    const dateInput = $('#dateInput');
    const wmInput = $('#watermarkInput');
    const imgInput = $('#imageInput');
    const listInput = $('#listInput');

    const frontTitle = $('#frontTitle');
    const watermark = $('#watermark');

    // GitHub/Discord inputs
    const ghOwner = $('#ghOwner');
    const ghRepo = $('#ghRepo');
    const ghBranch = $('#ghBranch');
    const ghToken = $('#ghToken');
    const discordWebhook = $('#discordWebhook');

    const storeKey = 'flip-card-participation-v1';
    const storeGhKey = 'flip-card-gh-config-v1';
    let viewMode = 'edit'; // 'edit' | 'card'

    function sanitize(list){
      return Array.from(new Set(list.map(x=>x.trim()).filter(x=>x.length>0))).sort((a,b)=>a.localeCompare(b,'ko'));
    }

    function render(list){
      namesEl.innerHTML = '';
      list.forEach(name=>{
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = name;
        namesEl.appendChild(pill);
      });
      countEl.textContent = list.length;
      badgeCount.textContent = `ğŸ‘¥ ì°¸ì—¬ ${list.length}`;
    }

    function save(){
      if(viewMode==='card') return; // viewer ëª¨ë“œì—ì„œ ì…ë ¥ ë¬´ì‹œ
      const data = {
        title: titleInput.value.trim() || 'ì´ë²¤íŠ¸ íƒ€ì´í‹€ ì˜ˆì‹œ : ë³´ìŠ¤ í† ë²Œì „',
        date: dateInput.value.trim() || new Date().toISOString().slice(0,10),
        water: wmInput.value.trim() || '@YourCommunity',
        img: imgInput.value.trim(),
        list: sanitize(listInput.value.split(/\n|,|;/))
      };
      localStorage.setItem(storeKey, JSON.stringify(data));
      apply(data);
    }

    function apply(data){
      frontTitle.textContent = data.title;
      watermark.textContent = data.water;
      if(data.date){ const dateBadge = front.querySelector('.badge'); if(dateBadge) dateBadge.textContent = `ğŸ“… ${data.date}`; }
      if(data.img){ front.style.backgroundImage = `url('${data.img}')`; }
      else { front.style.backgroundImage = "url('https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1400&auto=format&fit=crop')"; }
      render(data.list||[]);
    }

    function load(){
      const raw = localStorage.getItem(storeKey);
      if(raw){ try{const data = JSON.parse(raw); fillInputs(data); apply(data);}catch(e){} }
      const rawGh = localStorage.getItem(storeGhKey);
      if(rawGh){ try{const c = JSON.parse(rawGh); ghOwner.value=c.owner||''; ghRepo.value=c.repo||''; ghBranch.value=c.branch||'gh-pages'; ghToken.value=c.token||''; discordWebhook.value=c.webhook||'';}catch(e){} }
    }

    function fillInputs(data){
      titleInput.value = data.title || '';
      dateInput.value = data.date || '';
      wmInput.value = data.water || '';
      imgInput.value = data.img || '';
      listInput.value = (data.list||[]).join('\n');
    }

    function buildPayload(){
      return { t: titleInput.value.trim(), d: dateInput.value.trim(), w: wmInput.value.trim(), i: imgInput.value.trim(), l: sanitize(listInput.value.split(/\n|,|;/)) };
    }

    function encodeToUrl(opts={}){
      const payload = buildPayload();
      const q = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(payload)))));
      const u = new URL(location.href);
      u.searchParams.set('q', q);
      if(opts.view==='card') u.searchParams.set('view','card'); else u.searchParams.delete('view');
      u.hash = '';
      return u.origin + u.pathname + '?' + u.searchParams.toString();
    }

    function decodeFromUrl(){
      const u = new URL(location.href);
      const q = u.searchParams.get('q');
      viewMode = u.searchParams.get('view')==='card' ? 'card' : 'edit';
      if(!q){
        const emb = loadEmbedded();
        if(emb){ if(emb.view==='card') setCardOnlyMode(true); fillInputs(emb.data); apply(emb.data); return emb.data; }
      }
      if(viewMode==='card') setCardOnlyMode(true);
      if(!q) return null;
      try{
        const obj = JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(q)))));
        const data = { title: obj.t||'', date: obj.d||'', water: obj.w||'', img: obj.i||'', list: obj.l||[] };
        fillInputs(data); apply(data); if(viewMode!=='card') localStorage.setItem(storeKey, JSON.stringify(data));
        return data;
      }catch(e){ console.warn('ë§í¬ íŒŒì‹± ì‹¤íŒ¨', e); return null; }
    }

    // Embedded data loader (for exported HTML)
    function loadEmbedded(){
      try{
        const s = document.getElementById('__EMBEDDED_DATA__');
        if(!s) return null;
        const obj = JSON.parse(s.textContent||'{}');
        return { view: obj.view||'card', data: { title: obj.t||'', date: obj.d||'', water: obj.w||'', img: obj.i||'', list: obj.l||[] } };
      }catch(e){ return null; }
    }

    // Viewer mode: hide panel, disable inputs
    function setCardOnlyMode(on){
      document.body.classList.toggle('card-only', !!on);
      const inputs = document.querySelectorAll('.panel input, .panel textarea, .panel button');
      inputs.forEach(el=>{ el.disabled = !!on; });
    }

    // -------- Clipboard-safe helpers --------
    function openCopyModal(text){
      const modal = $('#copyModal'); const field = $('#copyField'); const status = $('#copyStatus');
      field.value = text; modal.classList.remove('hidden'); field.focus(); field.select();
      safeCopy(text)
        .then(ok=>{ status.textContent = ok ? 'ë³µì‚¬ ì™„ë£Œ! ë‹¤ë¥¸ ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.' : 'í´ë¦½ë³´ë“œ ê¶Œí•œ ì œí•œìœ¼ë¡œ ìë™ ë³µì‚¬ ì‹¤íŒ¨. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìˆ˜ë™ ë³µì‚¬í•˜ì„¸ìš”.'; })
        .catch(()=>{ status.textContent = 'ìë™ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì „ì²´ ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.'; });
    }

    async function safeCopy(text){
      try{ if(navigator.clipboard && window.isSecureContext){ await navigator.clipboard.writeText(text); return true; } }catch(e){}
      try{ const ta = document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.left='-9999px'; document.body.appendChild(ta); ta.focus(); ta.select(); const ok=document.execCommand('copy'); document.body.removeChild(ta); return ok; }catch(e){ return false; }
    }

    // -------- Standalone HTML (string) with OG --------
    function buildCardHtmlString(options={view:'card'}){
      const payload = buildPayload();
      const ogTitle = payload.t || 'Flip Card';
      const ogDesc = `${payload.d||''} Â· ì°¸ì—¬ ${payload.l.length}ëª…`;
      const ogImg = payload.i || '';

      const doc = document.documentElement.cloneNode(true);
      if(options.view==='card') doc.querySelector('body').classList.add('card-only');
      const script = doc.ownerDocument.createElement('script');
      script.type = 'application/json'; script.id = '__EMBEDDED_DATA__';
      script.textContent = JSON.stringify({ view: options.view, ...payload });
      doc.querySelector('body').appendChild(script);
      // Inject OG into <head>
      const head = doc.querySelector('head');
      const metas = [
        ['meta',{property:'og:title',content:ogTitle}],
        ['meta',{property:'og:description',content:ogDesc}],
        ['meta',{property:'og:type',content:'website'}],
      ];
      if(ogImg){ metas.push(['meta',{property:'og:image',content:ogImg}]); }
      metas.forEach(([tag,attrs])=>{ const m=doc.ownerDocument.createElement(tag); Object.entries(attrs).forEach(([k,v])=>m.setAttribute(k,v)); head.appendChild(m); });

      return '<!DOCTYPE html>\n' + doc.outerHTML;
    }

    function exportStandalone(options={view:'card'}){
      const html = buildCardHtmlString(options);
      const blob = new Blob([html], {type:'text/html;charset=utf-8'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const base = (titleInput.value.trim() || 'flip-card').replace(/[^\wê°€-í£\-_. ]+/g,'').slice(0,60).trim() || 'flip-card';
      a.download = options.view==='card' ? `${base}-card.html` : `${base}-editor.html`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // -------- GitHub API helpers --------
    function b64(text){ return btoa(unescape(encodeURIComponent(text))); }
    function slugify(str){ return (str||'card').toLowerCase().replace(/[^\wê°€-í£\- ]+/g,'').trim().replace(/\s+/g,'-').slice(0,80) || 'card'; }

    async function ghGet(path){
      const url = `https://api.github.com/repos/${ghOwner.value}/${ghRepo.value}/contents/${path}?ref=${ghBranch.value}`;
      const res = await fetch(url, { headers: { 'Authorization': `token ${ghToken.value}`, 'Accept':'application/vnd.github+json' } });
      if(res.status===404) return null; if(!res.ok) throw new Error(`GET ${path} ${res.status}`); return res.json();
    }

    async function ghPut(path, content, message){
      const get = await ghGet(path); const sha = get && get.sha;
      const url = `https://api.github.com/repos/${ghOwner.value}/${ghRepo.value}/contents/${path}`;
      const body = { message, content: b64(content), branch: ghBranch.value }; if(sha) body.sha = sha;
      const res = await fetch(url, { method:'PUT', headers:{ 'Authorization': `token ${ghToken.value}`, 'Accept':'application/vnd.github+json' }, body: JSON.stringify(body) });
      if(!res.ok) throw new Error(`PUT ${path} ${res.status}`); return res.json();
    }

    function computeBaseUrl(){
      return `https://${ghOwner.value}.github.io/${ghRepo.value}`;
    }

    const viewerTemplate = () => `<!DOCTYPE html>
<html lang="ko"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ì¹´ë“œ ë·°ì–´</title>
<style>body{margin:0;background:#0b0d10;color:#e8f0ff;font-family:ui-sans-serif,system-ui;-webkit-font-smoothing:antialiased} .layout{display:grid;grid-template-columns:300px 1fr;min-height:100vh} aside{background:#0f141c;border-right:1px solid #1a2230;padding:12px} main{display:grid;place-items:center;padding:12px} h1{font-size:16px;margin:8px 8px 12px;color:#cfe1ff} .item{display:flex;gap:8px;align-items:center;padding:8px;margin:6px;border:1px solid #1a2230;border-radius:10px;background:#0b0f15;cursor:pointer} .item:hover{border-color:#2a3952} .thumb{width:48px;height:32px;background:#111;border-radius:6px;background-size:cover;background-position:center} .meta{display:flex;flex-direction:column;font-size:12px} .meta .t{font-weight:700} iframe{width:1028px;max-width:95vw;height:720px;border:0;border-radius:16px;box-shadow:0 20px 50px rgba(0,0,0,.35);background:#111} .footer{color:#9fb3cc;font-size:12px;text-align:center;padding:8px;border-top:1px solid #1a2230}</style>
</head><body>
<div class="layout">
  <aside>
    <h1>ì¹´ë“œ íˆìŠ¤í† ë¦¬</h1>
    <div id="list"></div>
    <div class="footer">Â© ì¹´ë“œ ë·°ì–´</div>
  </aside>
  <main>
    <iframe id="viewer" title="ì¹´ë“œ ë¯¸ë¦¬ë³´ê¸°"></iframe>
  </main>
</div>
<script>
(async function(){
  async function loadHistory(){
    const res = await fetch('history.json', {cache:'no-cache'}); if(!res.ok) throw new Error('history.json ë¡œë“œ ì‹¤íŒ¨'); return res.json();
  }
  const listEl = document.getElementById('list'); const frame = document.getElementById('viewer');
  const hist = await loadHistory();
  function render(items){ listEl.innerHTML=''; items.forEach((it,idx)=>{ const d=document.createElement('div'); d.className='item'; d.innerHTML=\`<div class="thumb" style="background-image:url(\'\${it.image||''}\')"></div><div class="meta"><div class="t">\${it.title}</div><div>\${it.date} Â· ì°¸ì—¬ \${it.count}ëª…</div></div>\`; d.addEventListener('click',()=>{ frame.src = it.url; }); listEl.appendChild(d); if(idx===0){ frame.src = it.url; } }); }
  render(hist);
})();
<\/script>
</body></html>`;

    async function deployToGithub(){
      // validations
      if(!ghOwner.value || !ghRepo.value || !ghBranch.value || !ghToken.value){ alert('GitHub ì„¤ì •ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      const payload = buildPayload();
      const date = payload.d || new Date().toISOString().slice(0,10);
      const slug = `${date}-${slugify(payload.t||'card')}`;
      const cardHtml = buildCardHtmlString({view:'card'});

      // 1) push card file
      const cardPath = `cards/${slug}.html`;
      await ghPut(cardPath, cardHtml, `feat(card): ${slug}`);

      // 2) update history.json
      const baseUrl = computeBaseUrl();
      const cardUrl = `${baseUrl}/${cardPath}`;
      let hist = [];
      const existed = await ghGet('history.json');
      if(existed && existed.content){ try{ hist = JSON.parse(decodeURIComponent(escape(atob(existed.content)))); }catch(e){ hist = []; } }
      const entry = { id: slug, title: payload.t||'ë¬´ì œ', date, image: payload.i||'', count: payload.l.length, url: cardUrl, createdAt: new Date().toISOString() };
      // de-dup by id then unshift
      hist = [entry, ...hist.filter(x=>x.id!==entry.id)];
      await ghPut('history.json', JSON.stringify(hist, null, 2), `chore(history): add ${slug}`);

      // 3) ensure viewer index.html exists
      const idx = await ghGet('index.html');
      if(!idx){ await ghPut('index.html', viewerTemplate(), 'chore(viewer): bootstrap index'); }

      // 4) optional discord webhook
      if(discordWebhook.value){ try{ await fetch(discordWebhook.value, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ content: `ìƒˆ ì¹´ë“œ ë“±ë¡: ${payload.t}\në³´ê¸°: ${cardUrl}\nì „ì²´ íˆìŠ¤í† ë¦¬: ${baseUrl}/` }) }); }catch(e){} }

      alert(`ë°°í¬ ì™„ë£Œ!\nì¹´ë“œ: ${cardUrl}\níˆìŠ¤í† ë¦¬: ${baseUrl}/`);
    }

    // Demo data
    const demo = { title:'ê²°ì‚¬ ì£¼ê°„ ë ˆì´ë“œ : ì ˆëŒ€ì ê³µëµ', date: new Date().toISOString().slice(0,10), water:'@TheWind Guild', img:'', list:['ë…¸ë£¨','ì†Œì•ˆ','ìœˆë‘¥ì´','ì•„í†°','ì•„ì˜¤í‚¤ì§€','ë¬´ì¸ ','ë£¨ë¯¸','ë¼í‹°','ì¹¸ë‚˜','ì‹œì˜¨','ì—ë¦¬ì¹´','ì§„','ë¼ê·¸','ì¹´ì¼','ë©”ì´','í•€','ë¡œì›°','ì„¸ë¼','í•˜ì¹´','ë„ìœ¤'] };

    // Events
    $('#flip').addEventListener('click', ()=> card.classList.toggle('is-flipped'));
    card.addEventListener('click', ()=> card.classList.toggle('is-flipped'));
    card.addEventListener('keydown', (e)=>{ if(e.key==='Enter') card.classList.add('is-flipped'); if(e.key==='Escape') card.classList.remove('is-flipped'); });

    $('#save').addEventListener('click', save);
    $('#clearAll').addEventListener('click', ()=>{ if(viewMode==='card') return; localStorage.removeItem(storeKey); location.reload(); });
    $('#loadDemo').addEventListener('click', ()=>{ if(viewMode==='card') return; fillInputs(demo); apply(demo); localStorage.setItem(storeKey, JSON.stringify(demo));});

    // Sharing
    $('#exportUrl').addEventListener('click', ()=>{ const url = encodeToUrl({view:'edit'}); openCopyModal(url); });
    $('#exportCardOnlyUrl').addEventListener('click', ()=>{ const url = encodeToUrl({view:'card'}); openCopyModal(url); });
    $('#exportHtmlCard').addEventListener('click', ()=> exportStandalone({view:'card'}) );
    $('#exportHtmlEditor').addEventListener('click', ()=> exportStandalone({view:'edit'}) );

    // GitHub config
    $('#saveGhConfig').addEventListener('click', ()=>{ localStorage.setItem(storeGhKey, JSON.stringify({ owner: ghOwner.value.trim(), repo: ghRepo.value.trim(), branch: ghBranch.value.trim()||'gh-pages', token: ghToken.value.trim(), webhook: discordWebhook.value.trim() })); alert('GitHub/ì›¹í›… ì„¤ì • ì €ì¥ë¨(ë¡œì»¬)'); });
    $('#clearGhConfig').addEventListener('click', ()=>{ localStorage.removeItem(storeGhKey); ghOwner.value=''; ghRepo.value=''; ghBranch.value='gh-pages'; ghToken.value=''; discordWebhook.value=''; alert('ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.'); });
    $('#deployGithub').addEventListener('click', deployToGithub);

    // Modal events
    $('#tryCopyBtn').addEventListener('click', async ()=>{ const url = $('#copyField').value; const ok = await safeCopy(url); $('#copyStatus').textContent = ok ? 'ë³µì‚¬ ì™„ë£Œ! ë‹¤ë¥¸ ê³³ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”.' : 'ë³µì‚¬ ì‹¤íŒ¨. ì „ì²´ ì„ íƒ í›„ Ctrl/Cmd+Cë¡œ ë³µì‚¬í•˜ì„¸ìš”.'; });
    $('#selectBtn').addEventListener('click', ()=>{ const f=$('#copyField'); f.focus(); f.select(); });
    $('#closeModal').addEventListener('click', ()=> $('#copyModal').classList.add('hidden'));
    $('#shareBtn').addEventListener('click', async ()=>{ const url = $('#copyField').value; if(navigator.share){ try{ await navigator.share({title:'Flip Card ì°¸ì—¬ë³´ë“œ', text:'ê³µìœ  ë§í¬', url}); }catch(e){} } else { $('#copyStatus').textContent = 'ì´ ë¸Œë¼ìš°ì €ëŠ” ì‹œìŠ¤í…œ ê³µìœ ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³µì‚¬ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì„¸ìš”.'; } });

    // Diagnostics / Test cases
    function logDiag(msg){ console.log(msg); alert(msg); }
    function runDiagnostics(){
      // 1) URL encode/decode roundtrip
      let ok1=false; try{ const payload=buildPayload(); const url=encodeToUrl({view:'edit'}); const q=new URL(url).searchParams.get('q'); const obj=JSON.parse(decodeURIComponent(escape(atob(decodeURIComponent(q))))); ok1 = JSON.stringify({t:payload.t,d:payload.d,w:payload.w,i:payload.i,l:payload.l})===JSON.stringify(obj); }catch(e){}
      // 2) localStorage R/W
      let ok2=false; try{ const k='__test_'+Math.random(); localStorage.setItem(k,'1'); ok2 = localStorage.getItem(k)==='1'; localStorage.removeItem(k);}catch(e){}
      // 3) Embedded export sample
      let ok3=false; try{ const html=buildCardHtmlString({view:'card'}); ok3 = html.includes('__EMBEDDED_DATA__'); }catch(e){}
      // 4) GitHub config present
      const ok4 = !!(ghOwner.value && ghRepo.value && ghBranch.value && ghToken.value);
      logDiag(`ì§„ë‹¨ ê²°ê³¼:\n1) ë§í¬ ì¸ì½”ë”©/ë””ì½”ë”©: ${ok1?'OK':'FAIL'}\n2) ë¡œì»¬ ì €ì¥ì†Œ: ${ok2?'OK':'FAIL'}\n3) ë‚´ë³´ë‚´ê¸°(ì„ë² ë“œ) ìƒì„±: ${ok3?'OK':'FAIL'}\n4) GitHub ì„¤ì • ì…ë ¥ë¨: ${ok4?'OK':'ë¯¸ì…ë ¥'}`);
    }
    $('#runDiag').addEventListener('click', runDiagnostics);

    // First load
    if(!decodeFromUrl()) load();
  </script>
</body>
</html>
